<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Driftboard Admin Dashboard</title>
    <style>
      body { font-family: system-ui, -apple-system, sans-serif; margin: 0; padding: 24px; background: #0b1220; color: #e6edf7; }
      .card { background: #111a2e; border: 1px solid #1f2a44; border-radius: 12px; padding: 16px; box-shadow: 0 8px 30px rgba(0,0,0,0.25); cursor: pointer; transition: all 0.2s; }
      .card:hover { border-color: #2563eb; transform: translateY(-2px); box-shadow: 0 12px 40px rgba(37, 99, 235, 0.2); }
      .grid { display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); margin-top: 16px; }
      button { background: #2563eb; color: white; border: none; border-radius: 8px; padding: 10px 14px; cursor: pointer; font-weight: 600; margin-right: 8px; }
      button:hover { background: #1d4ed8; }
      .muted { color: #9fb3c8; }
      .details-view { display: none; margin-top: 24px; }
      .details-view.active { display: block; }
      .back-btn { background: #374151; }
      .back-btn:hover { background: #4b5563; }
      table { width: 100%; border-collapse: collapse; margin-top: 16px; font-size: 0.9em; }
      th, td { padding: 12px; text-align: left; border-bottom: 1px solid #1f2a44; }
      th { background: #1a243a; font-weight: 700; }
      tr:hover { background: #111a2e; }
      .entity-id { color: #60a5fa; font-family: monospace; font-size: 0.85em; }
    </style>
  </head>
  <body>
    <!-- Overview View -->
    <div id="overview-view" class="overview-view">
      <h1>Driftboard Admin Dashboard</h1>
      <p class="muted">Manual refresh; click metrics to drill down.</p>
      <div>
        <button id="refresh">Refresh</button>
      </div>
      <div id="status" class="muted" style="margin-top:8px;"></div>
      <div class="grid" id="grid"></div>
    </div>

    <!-- Details View -->
    <div id="details-view" class="details-view">
      <button id="back-btn" class="back-btn">← Back</button>
      <h2 id="details-title"></h2>
      <table id="details-table">
        <thead>
          <tr id="table-header"></tr>
        </thead>
        <tbody id="table-body"></tbody>
      </table>
    </div>

    <script>
      const statusEl = document.getElementById('status');
      const gridEl = document.getElementById('grid');
      const refreshBtn = document.getElementById('refresh');
      const overviewView = document.getElementById('overview-view');
      const detailsView = document.getElementById('details-view');
      const detailsTitle = document.getElementById('details-title');
      const tableHeader = document.getElementById('table-header');
      const tableBody = document.getElementById('table-body');
      const backBtn = document.getElementById('back-btn');

      const entityConfig = {
        users: { endpoint: '/api/users', title: 'Users', fields: ['id', 'email', 'displayName', 'createdAt'] },
        boards_current: { endpoint: '/api/boards', title: 'Boards', fields: ['id', 'title', 'userId', 'createdAt'] },
        lists_current: { endpoint: '/api/lists', title: 'Lists', fields: ['id', 'title', 'boardId', 'createdAt'] },
        cards_current: { endpoint: '/api/cards', title: 'Cards', fields: ['id', 'title', 'listId', 'status', 'createdAt'] },
        comments_current: { endpoint: '/api/comments', title: 'Comments', fields: ['id', 'text', 'cardId', 'userId', 'createdAt'] }
      };

      async function loadOverview() {
        statusEl.textContent = 'Loading...';
        try {
          const [kpiRes, deletedRes] = await Promise.all([
            fetch('/api/kpi'),
            fetch('/api/deleted-stats')
          ]);
          if (!kpiRes.ok || !deletedRes.ok) throw new Error('Request failed');
          const kpiData = await kpiRes.json();
          const deletedData = await deletedRes.json();

          const items = [
            { key: 'users', label: 'Users', value: kpiData.users },
            { key: 'boards_current', label: 'Boards', value: kpiData.boards_current },
            { key: 'lists_current', label: 'Lists', value: kpiData.lists_current },
            { key: 'cards_current', label: 'Cards', value: kpiData.cards_current },
            { key: 'comments_current', label: 'Comments', value: kpiData.comments_current }
          ];

          let html = items.map(item => `
            <div class="card" onclick="drillDown('${item.key}')">
              <div class="muted">${item.label}</div>
              <div style="font-size:28px; font-weight:700; margin-top:4px;">${item.value}</div>
            </div>
          `).join('');

          // Add deleted items section
          html += `<div style="grid-column: 1 / -1; margin-top: 24px;"><h3 style="margin-bottom: 12px;">Deleted Items (Pending Auto-Delete)</h3></div>`;

          deletedData.forEach(({ collection, recent, medium, old }) => {
            const label = collection === 'lists_current' ? 'Lists' : 'Cards';
            html += `
              <div class="card" onclick="drillDownDeleted('${collection}', 'recent')">
                <div class="muted">${label} (0-30 days)</div>
                <div style="font-size:28px; font-weight:700; margin-top:4px; color:#fbbf24;">${recent}</div>
              </div>
              <div class="card" onclick="drillDownDeleted('${collection}', 'medium')">
                <div class="muted">${label} (31-60 days)</div>
                <div style="font-size:28px; font-weight:700; margin-top:4px; color:#f97316;">${medium}</div>
              </div>
              <div class="card" onclick="drillDownDeleted('${collection}', 'old')">
                <div class="muted">${label} (>60 days)</div>
                <div style="font-size:28px; font-weight:700; margin-top:4px; color:#ef4444;">${old}</div>
              </div>
            `;
          });

          gridEl.innerHTML = html;
          statusEl.textContent = 'Updated';
        } catch (err) {
          statusEl.textContent = 'Error loading data';
          console.error(err);
        }
      }

      function formatValue(value, fieldName) {
        if (value === null || value === undefined) return '—';
        if (fieldName === 'id') return `<span class="entity-id">${String(value).slice(0, 16)}...</span>`;
        if (fieldName === 'createdAt' || fieldName === 'updatedAt') {
          // Handle Firestore Timestamp objects (serialized as {_seconds, _nanoseconds})
          if (typeof value === 'object' && value._seconds) {
            const date = new Date(value._seconds * 1000);
            return date.toLocaleString();
          }
          // Handle ISO strings
          if (typeof value === 'string') {
            const date = new Date(value);
            return isNaN(date) ? String(value) : date.toLocaleString();
          }
        }
        return String(value || '—');
      }

      async function drillDown(entityKey) {
        const config = entityConfig[entityKey];
        if (!config) return;

        try {
          const res = await fetch(config.endpoint);
          if (!res.ok) throw new Error('Request failed');
          const entities = await res.json();

          detailsTitle.textContent = config.title;

          // Build table header
          tableHeader.innerHTML = config.fields.map(field => `<th>${field}</th>`).join('');

          // Build table body
          tableBody.innerHTML = entities.slice(0, 50).map(entity => `
            <tr>
              ${config.fields.map(field => {
                const value = entity[field];
                const formatted = formatValue(value, field);
                return `<td>${formatted}</td>`;
              }).join('')}
            </tr>
          `).join('');

          overviewView.style.display = 'none';
          detailsView.classList.add('active');
        } catch (err) {
          console.error(err);
          detailsTitle.textContent = 'Error loading details';
        }
      }

      async function drillDownDeleted(collection, range) {
        const rangeLabels = {
          recent: '0-30 days old',
          medium: '31-60 days old',
          old: '>60 days old'
        };
        const collectionLabel = collection === 'lists_current' ? 'Lists' : 'Cards';

        try {
          const res = await fetch(`/api/deleted/${collection}/${range}`);
          if (!res.ok) throw new Error('Request failed');
          const entities = await res.json();

          detailsTitle.textContent = `Deleted ${collectionLabel} (${rangeLabels[range]})`;

          const fields = collection === 'lists_current' 
            ? ['id', 'title', 'boardId', 'updatedAt', 'status']
            : ['id', 'title', 'listId', 'updatedAt', 'status'];

          // Build table header
          tableHeader.innerHTML = fields.map(field => `<th>${field}</th>`).join('');

          // Build table body
          tableBody.innerHTML = entities.slice(0, 50).map(entity => `
            <tr>
              ${fields.map(field => {
                const value = entity[field];
                const formatted = formatValue(value, field);
                return `<td>${formatted}</td>`;
              }).join('')}
            </tr>
          `).join('');

          overviewView.style.display = 'none';
          detailsView.classList.add('active');
        } catch (err) {
          console.error(err);
          detailsTitle.textContent = 'Error loading deleted items';
        }
      }

      function goBack() {
        overviewView.style.display = 'block';
        detailsView.classList.remove('active');
      }

      refreshBtn.addEventListener('click', loadOverview);
      backBtn.addEventListener('click', goBack);
      loadOverview();
    </script>
  </body>
</html>
