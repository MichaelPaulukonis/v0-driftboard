# PLAN STATUS: üü° MOSTLY COMPLETE - Core implementation done, some minor items remaining

# Hybr### 9. UI Updates

- [x] Default: show only `status == active`. ‚úÖ IMPLEMENTED
- [ ] **REMAINING**: Add toggles for done/archived/deleted views.
- [ ] **REMAINING**: Card/task history view ‚Üí fetch subcollection.
- [ ] **REMAINING**: "Undo/Restore" ‚Üí update status back to active, add history entry.

## üìã REMAINING TASKS SUMMARY

1. **Update TypeScript types**: Add `status` field to all interfaces in `lib/types.ts`, remove `isDeleted` from Comment interface
2. **Security Rules**: Implement Firestore security rules for the new data model
3. **UI Features**: Add history view, restore functionality, and status filter togglesestore Data Strategy ‚Äî Implementation Checklist

### 1. Data Model Changes

- [x] Add `status` field to all entities: `active | done | deleted | archived | inactive`. ‚úÖ IMPLEMENTED in firebase-service.ts
- [x] Replace legacy `isDeleted` boolean ‚Üí map to `status: 'deleted'`. ‚úÖ IMPLEMENTED in firebase-service.ts
- [ ] **REMAINING**: Update TypeScript types in lib/types.ts to include status field (Comment interface still uses isDeleted)
- [x] Add metadata fields to current docs: ‚úÖ IMPLEMENTED
    - [x] `createdAt` (serverTimestamp), `createdBy` (uid)
    - [x] `updatedAt` (serverTimestamp), `updatedBy` (uid)
- [x] Use timestamps (not integers) for version ordering. ‚úÖ IMPLEMENTED
- [x] Add `position` float to list-ordered entities (cards, tasks). ‚úÖ IMPLEMENTED

---

### 2. Collections & Subcollections

- [x] `*_current/{entityId}` ‚Üí one document per logical entity (fast reads). ‚úÖ IMPLEMENTED
- [x] `*_current/{entityId}/history/{historyId}` ‚Üí immutable snapshots of every change. ‚úÖ IMPLEMENTED
- [x] Example: `cards_current/{cardId}/history/{autoId}`. ‚úÖ IMPLEMENTED

---

### 3. History Document Shape

- [x] Fields: ‚úÖ IMPLEMENTED
    - [x] `changeType`: `create|update|delete|done|restore`
    - [x] `createdAt` (serverTimestamp), `createdBy` (uid)
    - [x] `snapshot`: full copy of the entity state at that time
    - [x] `summary` (optional human-readable description)

---

### 4. Write Patterns

- [x] **Create**: write current doc + initial history (`changeType: create`) in one batch. ‚úÖ IMPLEMENTED
- [x] **Update**: batch/transaction ‚Üí add history entry (`changeType: update`, full snapshot), then update current doc (`updatedAt/By`). ‚úÖ IMPLEMENTED
- [x] **Soft delete**: history entry (`changeType: delete`), set `status: deleted`. ‚úÖ IMPLEMENTED
- [x] **Mark done**: history entry (`changeType: done`), set `status: done`. ‚úÖ IMPLEMENTED
- [x] **Restore**: history entry (`changeType: restore`), set `status: active`. ‚úÖ IMPLEMENTED

---

### 5. Query Patterns

- [x] Active items: `where('status','==','active')` on `*_current`. ‚úÖ IMPLEMENTED
    - [x] **Note**: ALL data-fetching functions in the application have been updated to include a `where('status', '==', 'active')` clause to hide soft-deleted items from the UI by default. ‚úÖ VERIFIED
- [x] Done/archived: include those statuses in query. ‚úÖ IMPLEMENTED
- [x] History: order by `createdAt desc` in subcollection. ‚úÖ IMPLEMENTED
- [x] Recent activity: order `*_current` by `updatedAt desc`. ‚úÖ IMPLEMENTED

---

### 6. Firestore Indexes

- [x] Composite: ‚úÖ IMPLEMENTED (automatically created by Firestore based on queries)
    - [x] `listId + status + position` (for ordered list queries).
    - [x] `boardId + updatedAt` (for activity feeds).
- [x] Rely on Firestore prompts for additional needed indexes. ‚úÖ IMPLEMENTED

---

### 7. Security Rules

- [ ] **TODO**: Require `request.auth.uid != null`.
- [ ] **TODO**: Validate `status` is one of allowed enum values.
- [ ] **TODO**: Require server timestamps for `createdAt`/`updatedAt`.
- [ ] **TODO**: Allow client to write both current + history in batch.
- [ ] **TODO**: (Optional future hardening: restrict history writes to server functions.)

---

### 8. Migration Steps

**Note**: This migration is critical to resolve the current data integrity issue of hard deletes orphaning child documents (e.g., lists and cards remaining after a board is deleted).

- [x] **[DONE] 0. Pre-Migration: Unify on Soft Deletes** ‚úÖ COMPLETE
    - [x] The codebase has been updated to use soft deletes (`status: 'deleted'`) for all models.
    - [x] A migration script was used to backfill the `status` field on existing documents.
    - [x] This phase is complete. The next steps focus on the full migration to the `_current` and `history` structure.

- [x] **1. Backup Firestore.** ‚úÖ DONE
- [x] **2. For each doc in legacy collections:** ‚úÖ DONE
    - [x] Copy to new `*_current/{id}`.
    - [x] Map `isDeleted: true ‚Üí status: deleted`, else `status: active`.
    - [x] Set `createdAt/By` from existing fields; fallback to now.
    - [x] Set `updatedAt/By = createdAt/By` initially.
    - [x] Add `position` if missing.
- [x] **3. Seed initial history doc** (`changeType: create`, snapshot = original state). ‚úÖ DONE
- [x] **4. Switch UI reads/writes to new collections.** ‚úÖ DONE
- [x] **5. Remove/rename legacy collections only after validation.** ‚úÖ DONE

---

### 9. UI Updates

*   Default: show only `status == active`.
*   Add toggles for done/archived/deleted views.
*   Card/task history view ‚Üí fetch subcollection.
*   ‚ÄúUndo/Restore‚Äù ‚Üí update status back to active, add history entry.
*   Use `updatedAt/By` for ‚Äúlast edited‚Äù labels and activity feeds.

---

### 10. Cost & Performance

*   Expect 2 writes per change (current + history).
*   Reads stay cheap (from `*_current`).
*   Storage grows with history snapshots ‚Äî keep snapshots minimal.
*   Timestamps keep ordering trivial.

---

### 11. Concurrency

*   For critical updates (e.g., reordering): use Firestore transactions.
*   For simple edits: batched writes with optimistic UI.
*   Optionally detect conflicts by comparing `updatedAt` with UI-cached value.

---

### 12. Retention & GC

*   Default: keep all history indefinitely.
*   Optional later: scheduled cleanup/archiving of old history (Cloud Functions).
*   Permanent delete (GDPR) = remove both current + history manually.

---

‚úÖ **End result**: Fast reads from `*_current`, full immutable audit trail in per-entity history, consistent non-destructive lifecycle (`status` enum), lightweight security, easy migration, and clean UI hooks.

