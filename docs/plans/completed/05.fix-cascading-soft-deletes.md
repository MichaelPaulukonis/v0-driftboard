# Plan: Fix Cascading Soft-Deletes

**Author:** Gemini & User
**Date:** 2025-09-28
**Status:** ✅ Completed

## 1. Problem Definition

When a user deletes a List, the cards within that list become inaccessible or have their status improperly changed. This contradicts the application's soft-delete design principle and leads to a loss of data fidelity.

1.  **Data Orphaning/Loss:** Deleting a list does not properly handle the lifecycle of the cards within it. Active cards become orphaned, and my previous fix incorrectly marked all cards as 'deleted', losing their original 'done' or 'archived' state.
2.  **Incorrect UI Messaging:** The confirmation dialog for deleting a list is inaccurate and misleading.

## 2. Investigation Plan (Completed)

-   **Backend Logic:** Confirmed `listService.deleteList` only soft-deletes the list, orphaning all cards within it.
-   **Frontend Warning:** Confirmed the `AlertDialog` in `list-column.tsx` contains an inaccurate warning message.

## 3. Implementation Plan (Completed)

This revised plan incorporates user feedback to create a more nuanced and data-safe process.

-   **Step 3.1: Implement Refined Cascading Soft-Delete (Backend)** - ✅ DONE
-   **Step 3.2: Implement Smart List Restoration (Backend)** - ✅ DONE
-   **Step 3.3: Implement Orphaned Card Restore Workflow (Frontend)** - ✅ DONE
-   **Step 3.4: Correct UI Warning Message (Frontend)** - ✅ DONE

## 4. Verification (Completed)

After implementation, the fix was verified by ensuring:

1.  Deleting a list correctly soft-deletes the list and only its active cards.
2.  Restoring a list correctly restores the list and only the cards that were soft-deleted with it.
3.  Restoring an orphaned 'done' or 'archived' card prompts the user to select a new parent list.
4.  The delete confirmation dialog displays the new, accurate message.

## 5. Implementation Summary

All steps of the revised implementation plan have been successfully executed and verified.

-   **Backend:** The `deleteList` and `restoreList` functions in `lib/firebase-service.ts` now correctly handle cascading soft-deletes and smart restoration.
-   **Frontend:** The UI now provides an accurate warning when deleting lists and includes a robust workflow for restoring orphaned cards by allowing the user to re-parent them.
-   **Testing:** New tests have been added to `lib/__tests__/firebase-service.test.ts` to cover the new logic, and all tests are passing.
-   **Documentation:** A new reference document, `docs/reference/cascading-soft-deletes.md`, has been created.
