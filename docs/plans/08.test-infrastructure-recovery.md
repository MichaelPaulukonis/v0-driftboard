# PRD: Test Infrastructure Recovery and Enhancement Plan

**Date**: October 22, 2025  
**Priority**: Critical  
**Status**: Active  
**Assignee**: Development Team  

## Problem Statement

The Driftboard test suite has degraded significantly from a documented state of "43 tests passing across 7 test files" to a current state of only "16 passed and 4 failed tests over 8 test files." Critical testing infrastructure issues are preventing proper test execution:

### Current Issues Identified:
1. **CommonJS/ESM Import Conflicts**: Firebase mock configuration using `require('vitest')` in an ESM environment
2. **Missing Context Providers**: Component tests failing due to missing BoardContext and ColumnContext providers
3. **Outdated Test Patterns**: Tests not keeping pace with application architecture changes
4. **Documentation Drift**: `testing.md` claims don't match current reality
5. **Missing Dependencies**: Test environment lacking proper setup for new components
6. **No Test Automation**: No git hooks or CI integration to prevent test degradation

## Requirements

### Critical Requirements (Must Fix)
1. **Fix ESM/CommonJS Conflicts**: Resolve Vitest import issues in Firebase mocking
2. **Restore Context Provider Testing**: Ensure all component tests have proper context setup
3. **Achieve Test Parity**: Restore test count to documented levels (43+ tests)
4. **Update Testing Documentation**: Align `testing.md` with current reality
5. **Implement Test Automation**: Add pre-commit hooks and CI integration

### High Priority Requirements (Should Fix)
1. **Enhanced Mock Strategies**: Improve Firebase and context mocking patterns
2. **Component Test Coverage**: Add missing tests for new components and features
3. **Integration Test Stability**: Ensure reliable component integration testing
4. **Performance Optimization**: Reduce test execution time

### Medium Priority Requirements (Could Add)
1. **E2E Test Foundation**: Setup Playwright for end-to-end testing
2. **Visual Regression Testing**: Add screenshot-based testing for UI components
3. **Test Reporting**: Enhanced coverage reporting and metrics

## Technical Approach

### Phase 1: Critical Infrastructure Fixes (Week 1)

#### 1.1 Fix Firebase Mock Configuration
- **Problem**: `lib/firebase.ts` uses CommonJS `require('vitest')` in ESM environment
- **Solution**: Convert to dynamic ESM imports or move mock setup to test configuration
- **Files to Change**: `lib/firebase.ts`, `vitest.setup.ts`, `lib/__mocks__/`

#### 1.2 Resolve Context Provider Issues
- **Problem**: Components requiring BoardContext and ColumnContext failing in tests
- **Solution**: Create comprehensive test wrapper providers
- **Files to Change**: `vitest.setup.ts`, test utility files, all component tests

#### 1.3 Add Missing Dependencies
- **Problem**: `tiny-invariant` and other dependencies causing import failures
- **Solution**: Ensure all required packages are properly installed and configured
- **Files to Change**: `package.json`, dependency audit

#### 1.4 Fix Vitest Configuration
- **Problem**: Vitest mock hoisting and module resolution issues
- **Solution**: Update `vitest.config.ts` with proper ESM handling
- **Files to Change**: `vitest.config.ts`, mock configuration

### Phase 2: Test Recovery and Enhancement (Week 2)

#### 2.1 Audit and Fix Existing Tests
- **Action**: Review each of the 8 test files against current component implementations
- **Target**: Restore all previously passing tests
- **Metrics**: Achieve 43+ passing tests with 0 failures

#### 2.2 Update Test Patterns
- **Action**: Standardize test patterns for context providers, mocking, and async operations
- **Files**: Create test utilities in `lib/__tests__/test-utils.ts`

#### 2.3 Add Missing Component Tests
- **Action**: Identify components without tests and add comprehensive coverage
- **Priority Components**: 
  - `create-board-dialog.tsx`
  - `create-list-dialog.tsx`
  - `reparent-card-dialog.tsx`
  - `view-status-dialog.tsx`

### Phase 3: Automation and Quality Gates (Week 3)

#### 3.1 Git Hooks Implementation
- **Pre-commit Hook**: Run tests and linting before commits
- **Pre-push Hook**: Full test suite execution
- **Tools**: Husky + lint-staged

#### 3.2 CI/CD Integration
- **GitHub Actions**: Automated test execution on PRs and merges
- **Coverage Reporting**: Automated coverage reports and thresholds
- **Quality Gates**: Block merges on test failures

#### 3.3 Test Monitoring
- **Test Result Tracking**: Monitor test execution trends
- **Coverage Tracking**: Ensure coverage doesn't regress
- **Performance Monitoring**: Track test execution time

## Implementation Steps

### Step 1: Emergency Fixes (Day 1-2)
```bash
# 1. Fix Firebase mock imports
# 2. Add missing dependencies
# 3. Update vitest configuration
# 4. Restore basic test execution
```

### Step 2: Context Provider Setup (Day 3-4)
```bash
# 1. Create test wrapper utilities
# 2. Fix all context-dependent component tests
# 3. Verify authentication context mocking
```

### Step 3: Test Recovery (Day 5-7)
```bash
# 1. Audit each failing test
# 2. Update tests to match current implementations
# 3. Add missing tests for new components
# 4. Achieve target test count
```

### Step 4: Automation Setup (Day 8-10)
```bash
# 1. Install and configure Husky
# 2. Setup GitHub Actions workflow
# 3. Configure coverage reporting
# 4. Document new testing workflow
```

## Testing Strategy Updates

### New Test Organization
```
__tests__/
├── unit/               # Pure function tests
├── integration/        # Component integration tests  
├── e2e/               # End-to-end tests (future)
└── utils/             # Test utilities and helpers
```

### Test Wrapper Utilities
Create comprehensive test wrappers that provide:
- Authentication context
- Board context  
- Column context
- Firebase service mocking
- Router mocking (if needed)

### Mock Strategy Standardization
- **Service Layer**: Mock at Firebase service boundary
- **Context Providers**: Mock contexts with realistic data
- **External Libraries**: Mock drag-and-drop and UI libraries
- **Type Safety**: Ensure all mocks maintain TypeScript compatibility

## Acceptance Criteria

### Critical Success Metrics
- [ ] All 8 test files execute without import/configuration errors
- [ ] 43+ tests passing with 0 failures
- [ ] All component tests have proper context provider setup
- [ ] Firebase mocking works correctly in test environment
- [ ] Test execution time under 30 seconds

### Quality Gates
- [ ] Pre-commit hooks prevent commits with failing tests
- [ ] CI/CD pipeline runs tests on all PRs
- [ ] Coverage reporting shows current vs target coverage
- [ ] Documentation accurately reflects test status

### Developer Experience
- [ ] Clear error messages for test failures
- [ ] Fast feedback loop (< 10 seconds for basic test run)
- [ ] Easy test debugging with proper source maps
- [ ] Comprehensive test utilities for new test creation

## Risk Assessment

### High Risk
- **Breaking Changes**: Updating mock patterns may require extensive test rewrites
- **Time Investment**: Comprehensive test recovery may take longer than estimated
- **Dependency Conflicts**: New testing dependencies may conflict with existing packages

### Medium Risk
- **Performance Impact**: Git hooks may slow down development workflow
- **Maintenance Overhead**: Additional test infrastructure requires ongoing maintenance

### Mitigation Strategies
- **Incremental Approach**: Fix tests file by file to minimize disruption
- **Backup Strategy**: Maintain working branches during major refactoring
- **Documentation**: Comprehensive documentation of new testing patterns

## Dependencies

### External Dependencies
- Vitest framework stability
- React Testing Library compatibility
- Firebase SDK mock patterns
- GitHub Actions availability

### Internal Dependencies
- Application architecture stability
- Component interface consistency
- Context provider implementations

## Success Metrics

### Immediate (Week 1)
- 100% test files executing without errors
- 90% of previously passing tests restored
- Firebase mock configuration working

### Short-term (Month 1)
- 43+ tests passing consistently
- Pre-commit hooks preventing test failures
- CI/CD integration complete
- Documentation updated

### Long-term (Quarter 1)
- 80%+ code coverage maintained
- E2E test foundation established
- Zero test-related deployment blocks
- Developer satisfaction with testing workflow

## Future Enhancements

### Planned Improvements
1. **Visual Regression Testing**: Screenshot-based UI testing
2. **Performance Testing**: Load and stress testing capabilities
3. **Cross-browser Testing**: Multi-browser compatibility validation
4. **Accessibility Testing**: Automated a11y testing integration

### Tool Considerations
- **Playwright**: For E2E testing
- **Chromatic**: For visual regression testing  
- **Lighthouse CI**: For performance monitoring
- **axe-core**: For accessibility testing

## Conclusion

This plan addresses the critical test infrastructure issues while establishing a foundation for robust, automated testing that prevents future degradation. The phased approach ensures immediate problem resolution while building toward a comprehensive testing strategy that supports confident development and deployment.

The key to success will be treating tests as a first-class concern in the development process, with proper automation and quality gates to ensure they remain valuable and reliable as the application evolves.